var xosologinconfig = {
    rootPath: "/",
    clientId: GoogleClientId || "942222337911-blutdnvnpbqlm7aqlbfsnlsee2kleg8p.apps.googleusercontent.com",
    GoogleCapChaSiteKey: GoogleCapChaSiteKeyId || "6LdpLuoqAAAAAEYkL9oQ9V4cqD2eJ-6acJ_ng-VA",
    CookieAuthName: "XoSoAuthCookie",
    CookieAuthNameSave: "XoSoAuthCookieSaved",
    RedirectUri: domainCallBack || "https://xoso.com.vn/"
}, xosologin;
window.emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
$(function() {
    xosologin.init()
});
xosologin = {
    init: function() {
        this.events();
        xosologin.CheckLogin()
    },
    events: function() {
        $(document).on("click", ".login-user-thumb", function() {
            $(".login-user-drop").toggleClass("target-expanded")
        });
        $(".btn-showpass").on("click", function() {
            var t = $(this).closest(".form-group"), n, i;
            t.length && (n = t.find(".password"),
            n.length && (i = $(n).attr("type"),
            i == "password" ? ($(this).html('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m4 4 5.879 5.879M20 20l-5.879-5.879M9.88 9.88a3 3 0 1 0 4.243 4.243M9.878 9.878l4.242 4.242M6.768 6.768C4.728 8.1 2.964 10.026 2 12c1.746 3.576 6.122 7 10 7 1.738 0 3.575-.688 5.232-1.768M9.762 5.347A7.9 7.9 0 0 1 12 5c3.877 0 8.252 3.424 9.999 7-.552 1.13-1.366 2.245-2.345 3.241" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><\/svg>'),
            $(n).attr("type", "text")) : ($(this).html('<svg width="16" height="16" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M17.747 15.415c.238-.54.372-1.143.372-1.413 0-2.348-1.824-4.25-4.073-4.25s-4.073 1.902-4.073 4.25 2.037 3.887 4.073 3.887c1.303 0 2.462-.637 3.206-1.63a4.3 4.3 0 0 0 .495-.844m-3.701.349c.51 0 .975-.196 1.332-.518.432-.39.622-.965.622-1.244 0-1.174-.828-2.126-1.954-2.126S12 12.826 12 14c0 .81.92 1.764 2.046 1.764" fill="#000" fill-rule="evenodd"/><path clip-rule="evenodd" d="M1.092 14.272a.45.45 0 0 1 0-.545q.015-.018.028-.039C4.78 8.343 9.32 5.5 14.014 5.5c4.689 0 9.224 2.836 12.882 8.17a.58.58 0 0 1-.01.676C23.23 19.67 18.698 22.5 14.014 22.5c-4.705 0-9.257-2.857-12.922-8.228m2.847-.92a1.04 1.04 0 0 0 0 1.294c3.135 3.898 6.665 5.729 10.075 5.729s6.94-1.83 10.075-5.728a1.04 1.04 0 0 0 0-1.295c-3.135-3.897-6.665-5.727-10.075-5.727s-6.94 1.83-10.075 5.727" fill="#000" fill-rule="evenodd"/><\/svg>'),
            $(n).attr("type", "password"))))
        });
        $(document).on("click", ".header-account-thumb", function(n) {
            n.stopPropagation();
            $(".header-account-content").toggleClass("header-account-open")
        });
        $(document).on("click", function(n) {
            $(n.target).closest(".header-account-thumb, .header-account-content").length || $(".header-account-content").removeClass("header-account-open")
        });
        $(document).on("click", ".close-popup", function() {
            $(".popup-bg").length && $(".popup-bg").fadeOut("2000")
        });
        $(document).on("submit", ".formsubmit", function(n) {
            $(this).valid() || n.preventDefault()
        })
    },
    ajaxEvents: {
        OnComplete: function() {
            $(".ajaxLoading").html("");
            $(".ajaxLoadingRegister").html("");
            $(".btn-default").prop("disabled", !1).css("cursor", "default")
        },
        OnSuccess: function(n, t) {
            t == "success" ? n.status == !0 ? n.retval.length > 0 && alert(n.retval) : n.retval.length > 0 && alert(n.retval) : alert("Quý khách vui lòng thử lại sau.")
        },
        OnSuccessReload: function(n, t) {
            t == "success" ? n.status == !0 ? (n.retval.length > 0 && alert(n.retval),
            window.location.reload()) : n.retval.length > 0 && alert(n.retval) : alert("Quý khách vui lòng thử lại sau.")
        },
        OnFailure: function() {
            $(".ajaxLoading").html("");
            $(".btn-default-dark").prop("disabled", !1).css("cursor", "default")
        },
        LoginOnBegin: function() {
            $(".ajaxLoadingLogin").html('<image src="../assets/images/Loading_icon.gif" alt="Loading..." />');
            $(".btn-login").prop("disabled", !0).css("cursor", "wait")
        },
        LoginOnSuccess: function(n, t) {
            t == "success" ? n.status == !0 ? n.retval != null && n.retval.length > 0 && location.reload() : n.retval.length > 0 && alert(n.retval) : alert("Quý khách vui lòng thử lại sau.");
            $(".ajaxLoadingLogin").html("")
        },
        RegisterOnBegin: function() {
            $(".ajaxLoadingRegister").html('<image src="/images/loadingAnimation.gif" alt="Loading..." />');
            $(".btn-register").prop("disabled", !0).css("cursor", "wait")
        },
        RegisterOnSuccess: function(n, t) {
            t == "success" ? n.status == !0 ? n.retval.length > 0 && (alert("Đăng ký thành công!"),
            $("#_pop_register").removeClass("popup-expanded").addClass("popup-hidden"),
            $("#_pop_login").removeClass("popup-hidden").addClass("popup-expanded")) : n.retval.length > 0 && alert(n.retval) : alert("Quý khách vui lòng thử lại sau.");
            $(".ajaxLoadingRegister").html("");
            $(".btn-register").prop("disabled", !1).css("cursor", "auto")
        },
        ForgotPasswordOnSuccess: function(n, t) {
            t == "success" ? (n.retval.length > 0 && alert(n.retval),
            n.status == !0 && $("#_pop_login_pass").removeClass("popup-expanded").addClass("popup-hidden")) : alert("Quý khách vui lòng thử lại sau.");
            $(".ajaxLoadingRegister").html("")
        },
        RetrivePasswordOnBegin: function() {
            $(".ajaxLoadingRetrivePassword").html('<image src="../assets/images/Loading_icon.gif" alt="Loading..." />');
            $(".btn-retrive-password").prop("disabled", !0).css("cursor", "wait")
        },
        RetrivePasswordOnSuccess: function(n, t) {
            t == "success" ? n.jsonRetval.length > 0 && xosologin.dialog(null, "Thông báo", n.jsonRetval, null, 300, null) : alert("Quý khách vui lòng thử lại sau.");
            $(".ajaxLoadingRetrivePassword").html("")
        },
        ChangePassWordOnSuccess: function(n, t) {
            t == "success" ? n.status == !0 ? (n.retval.length > 0 && alert(n.retval),
            window.location.href = "/") : n.retval.length > 0 && alert(n.retval) : alert("Quý khách vui lòng thử lại sau.")
        }
    },
    CheckLogin: function() {
        var t = xosologin.getCookie(xosologinconfig.CookieAuthName), n;
        t != null && t.length ? (n = xosologin.getCookie(xosologinconfig.CookieAuthNameSave),
        n == null || n.length == 0 || xosologin.isRefreshCustomerServiceExpiresAt(n) ? fetch(`${xosologinconfig.rootPath}user/get-customer-information.html`).then(function(n) {
            if (n.status !== 200) {
                console.log("UrlAPI. Status Code: " + n.status);
                throw new Error;
            }
            n.json().then(function(n) {
                n.status == !0 && n.result.length && (xosologin.displayUserInfo(n.result),
                xosologin.setCookie(xosologinconfig.CookieAuthNameSave, n.result, 10))
            })
        }).catch(function(n) {
            console.error("Unable to retrieve data", n)
        }) : xosologin.displayUserInfo(n)) : setTimeout(function() {
            google != null && google.accounts != null && (google.accounts.id.initialize({
                client_id: xosologinconfig.clientId,
                callback: xosologin.handleCredentialResponse
            }),
            google.accounts.id.prompt())
        }, 1e3)
    },
    CheckCustomerInfo: function() {
        var n = xosologin.getCookie(xosologinconfig.CookieAuthName);
        n != null && n.length && fetch(`${xosologinconfig.rootPath}user/check-customer-information.html`).then(function(n) {
            if (n.status !== 200) {
                console.log("UrlAPI. Status Code: " + n.status);
                throw new Error;
            }
            n.json().then(function(n) {
                n.succeeded == !0 && n.messages.length && window.document.reload()
            })
        }).catch(function(n) {
            console.error("Unable to retrieve data", n)
        })
    },
    isRefreshCustomerServiceExpiresAt: function(n) {
        try {
            if (n.length) {
                var t = JSON.parse(n);
                if (t.ExpiresAt != null && t.ExpiresAt.length == 19) {
                    const n = t.ExpiresAt
                      , [i,r] = n.split(" ")
                      , [u,f,e] = r.split("/")
                      , [o,s,h] = i.split(":")
                      , c = new Date(Date.UTC(e, f - 1, u, o, s, h))
                      , l = new Date;
                    if (l >= c)
                        return !0
                }
            }
        } catch (i) {
            console.error(i)
        }
        return !1
    },
    displayUserInfo: function(n) {
        var t, i, s, r, h, p, u, c, f, e, o, y, g;
        if (n.length && (t = JSON.parse(n),
        t != null)) {
            if (i = t.FullName || t.CustomerName,
            i.indexOf("@") > -1 && (i = i.split("@")[0]),
            s = "/images/icon_user_avata.svg",
            r = "",
            t.Avatar != null && t.Avatar.length ? s = t.Avatar : i.length > 0 ? i.indexOf(" ") > 0 ? (h = i.split(" "),
            r = h[0].charAt(0) + h[h.length - 1].charAt(0)) : r = i.charAt(0) : t.Email.length > 0 && (r = t.Email.charAt(0)),
            p = window.location.href,
            u = `<div class="header-account-dropdown">
                <div class="header-account-thumb">`,
            u += r.length > 0 ? `<div class="header-account-image">${r}</div>` : `<div class="header-account-image"><img alt="${t.FullName}" src="${s}"/></div>`,
            u += `<div class="header-account-text">${i}</div>
					</div>`,
            u += `<div class="header-account-content">` + `<div class="box-profile">
                        <div class="thumb-profile">
							<div class="header-account-thumb">
								<div class="header-account-image">${r.length > 0 ? r : `<img alt="${t.FullName}" src="${s}"/>`}</div>
							</div>
						</div>
						<div class="tex-profile">
						    <div class="row-profile">
							    <div class="row-user-name">${i}</div>
							    <div class="row-user-mail">${t.Email}</div>
						    </div>`,
            t.ServiceName != null) {
                if (c = "",
                t.EndTimeService != null && typeof t.EndTimeService != "undefined ") {
                    var l = t.EndTimeService
                      , b = new Date
                      , a = new Date;
                    if (l.indexOf(" ") == -1)
                        [f,e,o] = l.split("/").map(Number),
                        a = new Date(o,e - 1,f);
                    else {
                        var [k,d] = l.split(" ")
                          , [v,w] = k.split(":").map(Number)
                          , [f,e,o] = d.split("/").map(Number);
                        a = new Date(o,e - 1,f,v,w)
                    }
                    a > b ? (y = "",
                    y = typeof v != "undefined" ? `${v.toString().padStart(2, "0")}:${w.toString().padStart(2, "0")} ${f.toString().padStart(2, "0")}/${e.toString().padStart(2, "0")}/${o}` : `${f.toString().padStart(2, "0")}/${e.toString().padStart(2, "0")}/${o}`,
                    c = `<div class="row-profile"><strong>Hết hạn:</strong> ${y}</div>`) : c = `<div class="row-profile"> <span class="font-bold">Hết hạn sử dụng</span></div >`
                }
                u += `<div class="row-profile">
							    Gói Bóng đá: <span class="color-red"><strong>${t.ServiceName}</strong></span>
						    </div>
						    <div class="row-profile"> ${c} </div >
											 
						    <div class="row-profile"> <a href="${xosologinconfig.rootPath}user/goi-dich-vu.html" class="btn-upgrade-package" title="Nâng cấp/Gia hạn">Nâng cấp/Gia hạn</a> </div>`
            }
            g = $("#bdUsePay").val();
            u += `</div>
					</div>` + `<ul class="nav-account ">` + `<li class="${p.indexOf("user/thong-tin-tai-khoan.html") != -1 ? "active" : ""}"><a href="${xosologinconfig.rootPath}user/thong-tin-tai-khoan.html"><svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6.035 18.74A8.97 8.97 0 0 0 12 21a8.97 8.97 0 0 0 5.965-2.26C17.672 17.687 15.569 17 12 17s-5.672.687-5.965 1.74m-1.434-1.615C5.726 15.638 8.37 15 12 15s6.274.638 7.4 2.125a9 9 0 1 0-14.799 0M12 23C5.925 23 1 18.075 1 12S5.925 1 12 1s11 4.925 11 11-4.925 11-11 11M8 10c0-2.244 1.58-4 4-4 2.414 0 4 1.922 4 4.2 0 3.28-1.782 4.8-4 4.8-2.24 0-4-1.573-4-5m2 0c0 2.27.818 3 2 3 1.178 0 2-.702 2-2.8 0-1.25-.784-2.2-2-2.2-1.266 0-2 .816-2 2"></path></svg>Thông tin tài khoản</a></li>`;
            u += `<li><a href="#" title="Đăng xuất" onclick="xosologin.logout()"><svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#000" stroke-linecap="round"><path d="M22 14v8H2v-8m5-7 5-5 5 5m-5-5v12"></path></svg>Đăng xuất</a></li>` + `</ul>` + `<div class="div-support-text">Hỗ trợ: <a href="https://zalo.me/0976773366" target="_blank"class="color-blue font-bold">Zalo</a> 
                    hoặc <strong>SĐT:</strong> <a class="color-red font-bold" href="tel:0976773366" target="_blank">0976773366</a></div>` + `</div >` + `</div>`;
            $(".w-user").html(u)
        }
    },
    logout: function() {
        xosologin.deleteCookie(xosologinconfig.CookieAuthNameSave);
        fetch(`${xosologinconfig.rootPath}user/logout.html`).then(function(n) {
            if (n.status !== 200) {
                console.log("UrlAPI. Status Code: " + n.status);
                throw new Error;
            }
            window.location.href = "/"
        }).catch(function(n) {
            console.error("Unable to retrieve data", n)
        })
    },
    handleCredentialResponse: function(n) {
        n.credential ? fetch(`${xosologinconfig.rootPath}user/login-by-google.html`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idToken: n.credential
            })
        }).then(n => n.json()).then(n => {
            n.success ? window.location.reload() : alert(n.message)
        }
        ).catch(n => {
            console.error("Lỗi đăng nhập Google:", n),
            alert("Lỗi hệ thống, vui lòng thử lại sau.")
        }
        ) : alert("Đăng nhập thất bại, vui lòng thử lại.")
    },
    parseJwt: function(n) {
        const t = n.split(".")[1]
          , i = t.replace(/-/g, "+").replace(/_/g, "/")
          , r = decodeURIComponent(atob(i).split("").map(function(n) {
            return "%" + ("00" + n.charCodeAt(0).toString(16)).slice(-2)
        }).join(""));
        return JSON.parse(r)
    },
    getCookie: function(n) {
        const t = document.cookie.split("; ").find(t => t.startsWith(n + "="))?.split("=")[1];
        return t ? decodeURIComponent(t) : null
    },
    setCookie: function(n, t, i) {
        try {
            const r = new Date;
            r.setTime(r.getTime() + i * 864e5);
            const u = `expires=${r.toUTCString()}`;
            document.cookie = `${n}=${encodeURIComponent(t)}; ${u}; path=/`
        } catch (r) {
            console.error("Error setting cookie:", r)
        }
    },
    deleteCookie: function(n) {
        document.cookie = `${n}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`
    },
    getParameterByName: function(n, t) {
        t || (t = window.location.href.toLowerCase());
        n = n.replace(/[\[\]]/g, "\\$&");
        var r = new RegExp("[?&]" + n.toLowerCase() + "(=([^&#]*)|&|#|$)")
          , i = r.exec(t);
        return i ? i[2] ? decodeURIComponent(i[2].replace(/\+/g, " ")) : "" : null
    },
    GoogleLogin: function() {
        var t = xosologinconfig.clientId
          , n = xosologinconfig.RedirectUri + "/account/google-callback"
          , i = `https://accounts.google.com/o/oauth2/auth?client_id=${t}&redirect_uri=${n}&scope=${"https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email"}&response_type=${"code"}&prompt=select_account`
          , r = window.open(i, "Google Login", "width=800, height=600");
        window.addEventListener("message", function(t) {
            if (t.origin === new URL(n).origin) {
                var i = t.data;
                r.close();
                xosologin.sendTokenToServer(i)
            }
        }, !1)
    },
    getResponse: function(n, t) {
        t = t.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var r = "[\\#&]" + t + "=([^&#]*)"
          , u = new RegExp(r)
          , i = u.exec(n);
        return i === null ? "" : i[1]
    },
    sendTokenToServer: function(n) {
        fetch("/account/google-callback", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                IdToken: n
            })
        }).then(n => {
            n.success ? window.location.reload() : n.message.length && alert("Đăng nhập thất bại: " + n.message)
        }
        )
    }
};
$.fn.googleLogin = function(n) {
    function i(n, t) {
        t = t.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var r = "[\\#&]" + t + "=([^&#]*)"
          , u = new RegExp(r)
          , i = u.exec(n);
        return i == null ? "" : i[1]
    }
    function r(t) {
        var i = n.userInfoUrl + t;
        fetch(i).then(n => {
            if (!n.ok)
                throw new Error("Network response was not ok");
            return n.json()
        }
        ).then(n => {
            fetch("/user/google-login.html", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    googleId: n.id,
                    Email: n.email,
                    Name: n.name || "",
                    GivenName: n.given_name || "",
                    FamilyName: n.family_name || "",
                    Picture: n.picture || "",
                    Key: "",
                    ReturnUrl: ""
                })
            }).then(n => n.json()).then(n => {
                n.success ? window.location.reload() : alert("Đăng nhập thất bại: " + (n.message || "Lỗi không xác định"))
            }
            )
        }
        ).catch(n => {
            console.error("Lỗi khi lấy dữ liệu:", n)
        }
        )
    }
    var t = {
        oAuthUrl: "https://accounts.google.com/o/oauth2/auth?",
        validUrl: "https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=",
        userInfoUrl: "https://www.googleapis.com/oauth2/v1/userinfo?access_token=",
        scope: "https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",
        redirectUrl: xosologinconfig.RedirectUri,
        clientId: xosologinconfig.clientId,
        type: "token",
        accessToken: "",
        accountInfoType: 1
    };
    n = $.extend(t, n);
    $(this).on("click", function(t) {
        t.preventDefault();
        var f = n.oAuthUrl + "scope=" + n.scope + "&client_id=" + n.clientId + "&redirect_uri=" + n.redirectUrl + "&response_type=" + n.type
          , u = window.open(f, "Đăng nhập tài khoản Google", "width=800, height=600")
          , e = window.setInterval(function() {
            try {
                u.document.URL.indexOf(n.redirectUrl) !== -1 && (window.clearInterval(e),
                n.accessToken = i(u.document.URL, "access_token"),
                u.close(),
                r(n.accessToken))
            } catch (t) {
                console.log(t)
            }
        }, 500)
    })
}
;
$(".googlelogin").googleLogin({
    accountInfoType: 2
});
$(".google-login").googleLogin({
    accountInfoType: 2
});
$(".google-connect").googleLogin({
    accountInfoType: 3
});
